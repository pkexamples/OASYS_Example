# OASYS.net Pre-/Post-Processor Examples

Full cable test automation requires input/output conduits that marshal data to and from MRP/ERP
systems. For OASYS.net, this is done through the use of separate executable programs that link
to the back-end factory data source(s). XML files convey the data between the systems. In
OASYS.net, a cable test is fully defined in an XML file called a "PK Cable Definition File" (.pkcbd)
which can be generated by an executable program (a pre-processor). OASYS.net consumes this file,
executes the cable measurement as defined in the file, and writes a new XML file called a
"PK Cable Results File" (.pkcbr). This results file contains all of the original data in the
.pkcbd file, plus additional information about the OTDR and fiber handling equipment used to
complete the measurement, and the analyzed test results. A .pkcbr file can be consumed by a
separate program (a post-processor) to push result data to a central data store, generate reports,
etc.

Pre- and post-processors are configured in the OASYS.net settings. It is required to specify
the full path to the .exe file(s) in order for OASYS.net to know how to launch one or both of
these programs. It is possible to use the same .exe file as a combined pre/post-processor
that is launched both at the start and the end of a cable measurement. The program would need
logic that decides whether to run the pre- or post-processing tasks based on the number of
command line arguments received. OASYS.net sends a single command line argument to a pre-
processor and three command arguments to a post-processor. OASYS.net will also consumes the
program exit code (the `Environment.ExitCode` enumeration in .NET languages). Any code other than
Success (value 0) causes OASYS.net to not proceed to measuring in the case of a pre-processor
and displays an error text box in either case.

This repository contains three projects:

- A "Data" project that contains the XML Schema Definition (XSD) files that define the data
structures that pre- and post-processor programs must use to write .pkcbd and .pkcbr files.
The OasysCable.cs source file is a file that was generated using the xsd.exe utility that is
included in the Microsoft .NET SDK. Other languages also provide such tools; it is not
necessary to write pre- and post-processors in a .NET Framework language. The only requirement
is that these programs must be able to run on Microsoft Windows.

- An example pre-processor. This is an unsophisticated program that does not attempt to
illustrate how data would be pulled from a factory MRP/ERP system. It provides a simple UI
allowing a user to choose a simple cable structure select pre-defined from test setup
components (stored in XML files) and shows how to combine the inputs into a full cable test
definition and serialze it to a .pkcbr file.

- An example post-processor. This too is an unsophisticated program.  It illustrates how
to consume a .pkcbr file and access the result data to write a CSV report file. A MRP/ERP
integrated solution would instead push measurement results to the back-end database. If
reporting were a requirement, this would best be accomplished with on-demand reporting tools
such as Crystal Reports or SQL Server Reporting Services.

## PK.OASYS.Data

The OasysCable.xsd and its internally referenced OTDR.xsd file declare the public interface
for the data structures necessary to construct a Cable Definition and serialize it into a
.pkcbd file and to deserialize a Cable Result (.pkcbr) file and consume its contained data
structures. The `xsd.exe` .NET utility can be executed on the `OasysCable.xsd` file to
generate a single source file in either C# or VB.Net using the Visual Studio Developer Command
Prompt.

Example of how to run `xsd.exe` in VS Developer Command Prompt to generate C# source file named
OasysCable.xsd. The current directory must be the directory containing both `OasysCable.xsd`
and `OTDR.xsd`.

```
C:\Dir_With_2XSD_Files>xsd OasysCable.xsd
```

This project contains several other source files:

- OASYSPaths.cs: Provides a static method that loads some OASYS.net configuration settings into
static fields.

- AnalysisDatabase.cs: Provides a Read/Delete data access layer to the 8000 Front Panel
analysis settings database. Create and update operations are available through the 8000 Front
Panel UI. In a fully integrate factory implementation, you may wish to integrate these setups
into back-end database and provide your own UI for system administrators (more later).

- OASYSSetupServer.cs: Takes the place of a database that loads OASYS.net Cable Setup
components from file and holds them in memory for use in the example pre-processor.

## Pre-Processor

The job of an OASYS.net pre-processor is to produce a .pkcbd file. OASYS.net passes the full
file path of the .pkcbd file specified in the OASYS.net settings as a command line argument
to the pre-processor. This file does not need to exist before a pre-processor executes, but
the pre-processor must write its .pkcbd file to this path, as this is where OASYS.net will
look for it. The path needs to be a location where any Windows user has write access, such as
any in any sub-directory of C:\Users\Public\Documents. We usually use:

```
C:\Users\Public\Documents\Photon Kinetics\OASYS\PreProc.pkcbd
```

The main components of a .pkcbd file are:

- Cable ID field(s), including the expected cable length.
- Cable Setup components
    - Fiber Type(s): fiber diameter, group index, and compatible buffer fiber type
    per wavelength
    - OTDR Setups(s): OTDR acquisition parameters per wavelength
    - Analysis Setup(s): Analyzer parameters (window width, event sensitivity, etc.) and
    pass/fail limits per wavelength
    - Ribbon Type(s) (optional): includes edge gap dimensions for automated handlers.
    - The cable "tree" structure, i.e. the hierarchical structure of fibers and their respective
    containers (tubes, ribbons, etc.) as well as the ID or "name" of each container and fiber,
    giving each fiber a unique "address" or "path" just as in a hierarchical file system. Each
    node (container or fiber) can be "tagged" with any one of each of the Cable Setup component
    types. Cable setup component types attached to container nodes are inherited through the
    child nodes, but can be overridden in child nodes. For a .pkcbd to be fully valid, each
    fiber node must have a Fiber Type, Analysis Setup, and OTDR Setup, either explicitly
    attached or inherited from a parent container. In the simplest scenario, if all fibers can
    be represented by the same fiber type and are to be tested in the same way, these 3 required
    components can be attached at the root "cable" level of the hierarchy.

In a fully automated system, there might be an "administrator" tool (or a login with admin. mode
feature of the pre-processor) that allows a test engineer to perform database database CRUD
operations on a Cable Setup components and to map these to different product types. The
simplest pre-processor UI for a cable test operator would provide a single input field, which
the operator would use to scan a bar code that might represent a MRP work order number from
which the entire cable structure can be built using logic in the pre-processor and accompanying
database queries to pull from the predefined and stored Cable Setup components.

## Post-Processor

When OASYS.net starts a post-procesor, it sends three command line arguments, though these are
a bit redundant, as they are all the same except for the file extension. They are the paths of
the .pkcbr, .log, and .csv files in the result directory for the cable test that is currently 
pen in OASYS.net. The most simple post-processor may choose to only extract data from the
"summary" .csv report file. A more sophisticated post-processor would deserialize the .pkcbr
file and walk through the hierarchical cable structure recursively until fiber nodes are
reached and process the results of each, append any errors to the log file, and possibly also
append to or overwrite the OASYS.net generated csv file.